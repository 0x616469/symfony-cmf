<!DOCTYPE html>
<html>
    <head>

        <!-- To render these slides you need Slippy https://github.com/Seldaek/slippy -->

        <title>Doctrine PHPCR ODM</title>

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <meta name="author" content="Symfony CMF" />
        <meta name="email" content="symfony-cmf-devs@googlegroups.com" />
        <meta name="date" content="2011-05-29" />
        <meta name="venue" content="The Internets" />

        <!-- Slippy core file and dependencies -->
        <script type="text/javascript" src="jquery.min.js"></script>
        <script type="text/javascript" src="jquery.history.js"></script>
        <script type="text/javascript" src="slippy.js"></script>
        <!-- Slippy structural styles -->
        <link type="text/css" rel="stylesheet" href="slippy.css"/>
        <!-- Slippy theme -->
        <link type="text/css" rel="stylesheet" href="slippy-pure.css"/>
        <!-- Syntax highlighting core file  -->
        <script type="text/javascript" src="highlighter/shCore.js"></script>
        <!-- Syntax highlighting brushes, remove those you don't need -->
        <script type="text/javascript" src="highlighter/shBrushPhp.js"></script>
        <script type="text/javascript" src="highlighter/shBrushPlain.js"></script>
        <script type="text/javascript" src="highlighter/shBrushXml.js"></script>
        <!-- Syntax highlighting styles-->
        <link type="text/css" rel="stylesheet" href="highlighter/shCore.css"/>
        <link type="text/css" rel="stylesheet" href="highlighter/shThemeEclipse.css"/>

        <style type="text/css">
            body > * {
                font-size: 1.2em;
            }

            body {
                background: #fff;
            }

            div.syntaxhighlighter {
                background: #aaa !important;
            }

            span.file {
                font-size: 0.8em;
                color: #f00;
                float: right;
                margin: -.2em .5em 0 0;
            }

            .smallcode {
                font-size: 0.8em;
            }

            strong {
                color: #662222;
            }
        </style>
        <!-- Slippy init code -->
        <script type="text/javascript">
            $(function() {
                $(".slide").slippy({
                });
                SyntaxHighlighter.all();
            });
        </script>
    </head>

    <body>
        <div class="slide" style="text-align:center">
            <h1>Doctrine PHPCR ODM</h1>
            <h1><a href="http://cmf.symfony.com">github.com/doctrine/phpcr-odm/</a></h1>
        </div>

        <div class="slide" style="text-align:center">
            <h2>PHP Content Repository + Doctrine ODM</h2>
            <h2>PHPCR (aka PHP-ified JCR specification)</h2>
        </div>

        <div class="slide" style="text-align:center">
            <h2>Works like MongoDB or CouchDB ODM, but also includes a tree/graph, versioning API</h2>
            <h2><img src="JCRvsRDBMSvsNoSQL.png" alt="JCR vs. RDBMS/NoSQL" /></h2>
        </div>

        <div class="slide" style="text-align:center">
            <h2>PHPCR provides a <strong>standardized API</strong> that can be used by any PHP content management system to interface with any content repository.</h2>
        </div>

        <div class="slide">
            <h2>PHPCR implementations</h2>
            <ul>
                <li>Jackalope
                    <ul>
                        <li>Davex (Jackrabbit) transport layer</li>
                        <li>Doctrine DBAL transport layer</li>
                    </ul>
                </li>
                <li>Midgard2 PHPCR</li>
                <li>..</li>
            </ul>
        </div>

        <div class="slide">
            <h2>PHPCR has been <a href="http://java.net/jira/browse/JSR_333-28" target="_blank">submitted</a> to the JCR spec at the request of David Nüschler, JCR spec lead</h2>
        </div>

        <div class="slide">
            <h2>Workspaces</h2>
            <ul>
                <li>Multiple workspaces, each with its own name and root node</li>
                <li>Is similar to a Unix file system structure</li>
                <li>Each workspace is independent</li>
            </ul>
        </div>

        <div class="slide">
            <h2>Nodes</h2>
            <ul>
                <li>Can be created, deleted, modified, copied...</li>
                <li>Are identified by their path (*)
                    <ul><li>ex. “/my/path/under/water/fish”</li></ul>
                </li>
                <li>Are typed using namespaced names
                    <ul><li>nt:unstructured, nt:folder, nt:file ...</li></ul>
                </li>
            </ul>
        </div>

        <div class="slide">
            <h2>Node mixins</h2>
            <ul>
                <li>A mixin node type can be assigned to a node during that node's lifetime
                    <ul>
                        <li>mix:referenceable implies availability of property
                            <ul>
                                <li>jcr:uuid</li>
                            </ul>
                        </li>
                        <li>mix:versionable implies availability of properties
                            <ul>
                                <li>jcr:versionHistory, jcr:predecessors, jcr:baseVersion, jcr:isCheckedOut, jcr:mergeFailed properties)</li>
                            </ul>
                        </li>
                        <li>...</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="slide">
            <h2>Properties</h2>
            <ul>
                <li>Use namespaced names
                    <ul><li>jcr:created, jcr:mimeType, phpcr:class</li></ul>
                </li>
                <li>Use one of the several type
                    <ul><li>STRING, URI, BOOLEAN, LONG, DOUBLE, DECIMAL, BINARY, DATE, NAME, PATH, WEAKREFERENCE, REFERENCE</li></ul>
                </li>
            </ul>
        </div>

        <div class="slide" style="text-align:center">
            <h2>PHPCR</h2>
            <h2><img src="phpcr.png" alt="PHPCR class interaction diagramm" /></h2>
        </div>

        <div class="slide">
            <h2>Document class</h2>
            <pre class="brush: php">
                namespace Foo;

                use Doctrine\ODM\PHPCR\Mapping as PHPCR

                /** @PHPCR\Document(alias="bar", repositoryClass="Foo\BarRepository") */
                class Bar
                {
                    /** @PHPCR\Id(strategy="repository") */
                    public $id;

                    /** @PHPCR\Children */
                    public $children;

                    /** @PHPCR\String(name="name") */
                    private $name;

                    public function getName()
                    {
                        return $this->name;
                    }

                    public function setName($name)
                    {
                        $this->name = $name;
                    }
                }
            </pre>
        </div>

        <div class="slide">
            <h2>Document repository (optional)</h2>
            <pre class="brush: php">
                namespace Foo;

                use Doctrine\ODM\PHPCR\DocumentRepository,
                    Doctrine\ODM\PHPCR\Id\RepositoryIdInterface;

                class BarRepository
                    extends DocumentRepository
                    implements RepositoryIdInterface
                {
                    /**
                     * Generate a document id
                     *
                     * @param Bar $document
                     * @return string
                     */
                    public function generateId(Bar $document)
                    {
                        return '/'.$document->getName();
                    }
                }
            </pre>
        </div>

        <div class="slide">
            <h2>CRUD API</h2>
            <pre class="brush: php">
                // Create
                $document = new Foo\Bar();
                $document->setName($name)
                $documentManager->persist($document);
                $documentManager->flush();
                $id = $document->id;

                // Read
                $repo = $documentManager->getRepository('Foo\Bar');
                $document = $repo->find($id);

                // Update
                $document->setName('foo!');
                $documentManager->flush();

                // Remove
                $documentManager->remove($document);
                $documentManager->flush();
            </pre>
        </div>

        <div class="slide">
            <h2>Traversal API</h2>
            <pre class="brush: php">
                $workspace = $documentManager->getWorkspace();
                $session = $workspace->getSession();
                $node = $session->getNode('/foo/bar/ding/dong');

                $i = 0;
                $breadcrumb = array();

                // note this code doesn't handle graphs
                do {
                    $i++;
                    $parent = $node->getAncestor($i);
                    $breadcrumb[$parent->getPath()] =
                        $parent->getPropertyValue('label');
                } while ($parent != $node);
            </pre>
        </div>

        <div class="slide">
            <h2>Versioning API</h2>
            <pre class="brush: php">
                // immediate predecessor(s)
                $repo = $documentManager->getRepository('Foo\Bar');
                $document = $repo->find($id);
                $predecessor = $repo->getPredecessor($document);
                echo $predecessor->getPropertyValue('label');

                // get entire history
                $workspace = $documentManager->getWorkspace();
                $versionManager = $workspace->getVersionManager()
                $history = $versionManager->getVersionHistory($id);

                foreach ($history->getAllVersions() as $node) {
                    echo $node->getPropertyValue('label');
                }
            </pre>
        </div>

        <div class="slide">
            <h2>Search via SQL2 API</h2>
            <pre class="brush: php">
                $queryManager = $workspace->getQueryManager();

                $sql = "SELECT * FROM [nt:unstructured]
                    WHERE [nt:unstructured].[phpcr:class] = 'Foo\Bar'
                    ORDER BY [nt:unstructured].title";
                $query = $queryManager->createQuery($sql, 'JCR-SQL2');
                $query->setLimit($limit);
                $query->setOffset($offset);
                $queryResult = $query->execute();

                foreach ($queryResult->getRows() as $row) {
                    $node = $row->getNode();
                }
            </pre>
        </div>

        <div class="slide">
            <h2>TODO: versioning, translation</h2>
            <pre class="brush: php">

            </pre>
        </div>

        <div class="slide">
            <h2>Next steps</h2>
            <ul>
                <li>Add mapping support for children, parents, versions</li>
                <li>Implement SQL2/OQM search query support</li>
                <li>Performance optimizations</li>
                <li>Make AdminBundle compatible and build frontend Bundles</li>
            </ul>
        </div>

        <div class="slide">
            <h2>Github projects</h2>
            <ul>
                <li><a href="https://github.com/phpcr/phpcr">PHPCR</a></li>
                <li><a href="https://github.com/jackalope/jackalope">Jackalope</a></li>
                <li><a href="https://github.com/doctrine/phpcr-odm">PHPCR ODM</a></li>
                <li><a href="https://github.com/Doctrine/DoctrinePHPCRBundle">DoctrinePHPCRBundle</a></li>
            </ul>
        </div>

        <div class="slide">
            <h2>Resources</h2>
            <ul>
                <li><a href="irc://freenode/#symfony-cmf">#symfony-cmf IRC</a></li>
                <li><a href="https://github.com/doctrine/phpcr-odm">PHPCR ODM</a> (the README is the doc)</li>
                <li><a href="http://jcp.org/en/jsr/detail?id=283">JSR 283 (aka JCR 2, read Chapter 3)</a></li>
                <li><a href="http://jcp.org/en/jsr/detail?id=333">JSR 333 (aka JCR 2.1)</a></li>
            </ul>
        </div>

        <div class="layout" data-name="default">
            <div class="vcenter">
                <content></content>
            </div>
        </div>

        <div class="footer">
            <span class="right"><a href="irc://freenode/#symfony-cmf">#symfony-cmf IRC</a></span>
            <span class="left"><a href="http://cmf.symfony.com">cmf.symfony.com</a></span>
            <hr class="defloat" />
        </div>
    </body>
</html>
